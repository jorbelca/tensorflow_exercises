<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.0.0/dist/tf.min.js"></script>
    <title>Capstone Project</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        line-height: 1.6;
        background: var(--bg);
      }
      h1 {
        color: #333;
      }
      .data,
      .model {
        margin: 10px 0;
        font-size: 1.2em;
      }
      .on {
        color: green;
        font-weight: bold;
      }
      .off {
        color: red;
        font-weight: bold;
      }
      #logs-container {
        margin-top: 20px;
      }
      #logs-header {
        cursor: pointer;
        background-color: #f0f0f0;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      #logs-content {
        /* ahora el colapso/expansión se maneja con [hidden] */
        padding: 10px;
        border: 1px solid #ccc;
        border-top: none;
        border-radius: 0 0 5px 5px;
        background-color: #fafafa;
        max-height: 200px;
        overflow-y: auto;
      }

      /* Nuevo: variables, layout, botones, grid y spinner */
      :root {
        --fg: #222;
        --muted: #666;
        --primary: #0069d9;
        --primary-hover: #0053ad;
        --border: #ddd;
        --card: #fff;
        --bg: #f8f9fa;
      }
      .container {
        max-width: 960px;
        margin: 0 auto;
      }
      .section {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 8px;
        padding: 12px 16px;
        margin: 12px 0;
      }
      .btn {
        appearance: none;
        border: 1px solid var(--primary);
        background: var(--primary);
        color: #fff;
        padding: 8px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
      }
      .btn:hover {
        background: var(--primary-hover);
      }
      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .btn-secondary {
        background: transparent;
        color: var(--primary);
      }
      .btn-secondary:hover {
        background: rgba(0, 0, 0, 0.04);
      }
      .btn-toggle {
        background: #f0f0f0;
        color: var(--fg);
        border-color: #ccc;
      }
      .file-name {
        display: block;
        color: var(--muted);
        font-size: 0.85rem;
        margin-top: 4px;
      }
      .media-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
        align-items: start;
        margin-top: 12px;
      }
      img#image,
      canvas#display {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 6px;
      }
      .spinner {
        display: inline-block;
        width: 1em;
        height: 1em;
        border: 2px solid rgba(0, 0, 0, 0.2);
        border-top-color: #fff;
        border-right-color: #fff;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        vertical-align: -2px;
        margin-left: 8px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
    <script type="module">
      import { createDataObject } from "./generateData.js";
      import { makeModel } from "./trainModel.js";
      import { dicify } from "./inference.js";

      // Exponer funciones usadas por manejadores inline en el HTML
      window.createDataObject = createDataObject;
      window.dicify = dicify;

      // Nuevo: envoltorio para gestionar UI durante la inferencia
      window.runInference = async function runInference() {
        const btn = document.getElementById("runBtn");
        const spinner = document.getElementById("spinner");
        try {
          btn.disabled = true;
          spinner.hidden = false;
          await dicify();
        } finally {
          spinner.hidden = true;
          btn.disabled = false;
        }
      };

      async function main() {
        await makeModel();
      }

      // Accesibilidad y mejoras de usabilidad
      const logsHeader = document.getElementById("logs-header");
      const logsContent = document.getElementById("logs-content");
      logsHeader.addEventListener("click", () => {
        const expanded = logsHeader.getAttribute("aria-expanded") === "true";
        logsHeader.setAttribute("aria-expanded", String(!expanded));
        logsContent.hidden = expanded;
      });

      // Mostrar nombres de archivos seleccionados
      document.getElementById("fileInput")?.addEventListener("change", (e) => {
        const files = Array.from(e.target.files || []);
        document.getElementById("fileInputName").textContent = files.length
          ? files.map((f) => f.name).join(", ")
          : "Ningún archivo seleccionado";
      });
      document.getElementById("model_path")?.addEventListener("change", (e) => {
        const files = Array.from(e.target.files || []);
        document.getElementById("modelPathName").textContent = files.length
          ? files.map((f) => f.name).join(", ")
          : "Ningún archivo seleccionado";
      });

      // Carga de imagen de prueba con previsualización
      document.getElementById("imageInput")?.addEventListener("change", (e) => {
        const file = (e.target.files || [])[0];
        if (file) {
          const url = URL.createObjectURL(file);
          const img = document.getElementById("image");
          img.src = url;
          document.getElementById("imageInputName").textContent = file.name;
        }
      });

      main();
    </script>
  </head>
  <body>
    <div class="container">
      <div>
        <h1>Capstone Project: Simple Neural Network with TensorFlow.js</h1>
      </div>

      <div class="section data">
        Training Data:
        <span class="on" style="display: none"> ok </span>
        <span class="off">❌ </span>
        <button class="btn btn-secondary" onclick="createDataObject();">
          Generate Training Data
        </button>
        <div>
          <span>Cargar Datos</span>
          <input type="file" id="fileInput" accept=".json" />
          <small id="fileInputName" class="file-name"></small>
        </div>
      </div>

      <div class="section model">
        Model:
        <span class="on" style="display: none"> ok </span>
        <span class="off">❌ </span>
        <input
          id="model_path"
          type="file"
          multiple
          accept=".json,.bin,.weights.bin"
        />
        <small id="modelPathName" class="file-name"></small>
        <div style="margin-top: 8px">
          <button id="runBtn" class="btn" onclick="runInference();">
            Run Inference
          </button>
          <span id="spinner" class="spinner" hidden></span>
        </div>
      </div>

      <div id="logs-container" class="section" style="display: none">
        <button
          id="logs-header"
          class="btn btn-toggle"
          type="button"
          aria-expanded="false"
          aria-controls="logs-content"
        >
          Logs (Click to Expand/Collapse)
        </button>
        <div id="logs-content" hidden>
          <p id="logs" aria-live="polite"></p>
        </div>
      </div>

      <div class="section">
        <div class="media-grid">
          <img
            id="image"
            src="./imgs/rayas.webp"
            width="140"
            height="140"
            alt="Imagen de entrada"
          />
          <canvas
            id="display"
            style="image-rendering: pixelated; width: 100%"
            width="100"
            height="100"
          ></canvas>
        </div>
        <div style="margin-top: 8px">
          <span>Cargar imagen de prueba</span>
          <input type="file" id="imageInput" accept="image/*" />
          <small id="imageInputName" class="file-name"></small>
        </div>
      </div>
    </div>
  </body>
</html>
